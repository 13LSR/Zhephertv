name: Release

on:
  push:
    tags:
      - 'v*.*.*'  # åŒ¹é… v1.0.0, v1.0.1 ç­‰æ ¼å¼çš„æ ‡ç­¾

permissions:
  contents: write
  packages: write

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´å†å²ï¼Œç”¨äºç”Ÿæˆå˜æ›´æ—¥å¿—

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.14.0

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Extract version from tag
        id: get_version
        run: |
          TAG_NAME=${GITHUB_REF#refs/tags/}
          VERSION=${TAG_NAME#v}
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "tag_name=${TAG_NAME}" >> $GITHUB_OUTPUT
          echo "ğŸ“¦ Version: ${VERSION}"

      - name: Update version files
        run: |
          # è¿è¡Œ convert-changelog.js è„šæœ¬
          # è„šæœ¬ä¼šæ£€æµ‹åˆ° GITHUB_ACTIONS ç¯å¢ƒå˜é‡ï¼Œè‡ªåŠ¨æ›´æ–°ç‰ˆæœ¬æ–‡ä»¶
          node scripts/convert-changelog.js

          # éªŒè¯ç‰ˆæœ¬æ–‡ä»¶å·²æ›´æ–°
          echo "=== VERSION.txt ==="
          cat VERSION.txt
          echo ""
          echo "=== src/lib/version.ts ==="
          grep CURRENT_VERSION src/lib/version.ts

      - name: Extract changelog for current version
        id: changelog
        run: |
          # ä» CHANGELOG æå–å½“å‰ç‰ˆæœ¬çš„æ›´æ–°å†…å®¹
          VERSION=${{ steps.get_version.outputs.version }}

          # ä½¿ç”¨ awk æå–å½“å‰ç‰ˆæœ¬çš„å†…å®¹
          CHANGELOG_CONTENT=$(awk "/## \[${VERSION}\]/,/## \[/" CHANGELOG | sed '$ d' | tail -n +2)

          # å¦‚æœæ²¡æœ‰æ‰¾åˆ°å†…å®¹ï¼Œä½¿ç”¨é»˜è®¤æ¶ˆæ¯
          if [ -z "$CHANGELOG_CONTENT" ]; then
            CHANGELOG_CONTENT="è¯¦è§ [CHANGELOG](./CHANGELOG)"
          fi

          # è¾“å‡ºåˆ° GitHub Actions
          echo "content<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG_CONTENT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Commit version updates
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹
          if git diff --quiet; then
            echo "æ²¡æœ‰éœ€è¦æäº¤çš„æ›´æ”¹"
          else
            git add VERSION.txt src/lib/version.ts src/lib/changelog.ts
            git commit -m "chore: bump version to ${{ steps.get_version.outputs.version }} [skip ci]"

            # æ¨é€åˆ°é»˜è®¤åˆ†æ”¯(main)
            git push origin HEAD:main
          fi

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.get_version.outputs.tag_name }}
          name: Release ${{ steps.get_version.outputs.version }}
          body: |
            ## ğŸ‰ Zhephertv ${{ steps.get_version.outputs.version }}

            ${{ steps.changelog.outputs.content }}

            ---

            ### ğŸ“¦ å®‰è£…æ–¹å¼

            **Docker éƒ¨ç½²ï¼š**
            ```bash
            docker pull ghcr.io/${{ github.repository_owner }}/zhephertv:${{ steps.get_version.outputs.version }}
            ```

            **æºç éƒ¨ç½²ï¼š**
            ```bash
            git clone -b ${{ steps.get_version.outputs.tag_name }} https://github.com/${{ github.repository }}.git
            cd zhephertv
            pnpm install
            pnpm build
            pnpm start
            ```

            ### ğŸ”— ç›¸å…³é“¾æ¥
            - [å®Œæ•´å˜æ›´æ—¥å¿—](./CHANGELOG)
            - [é¡¹ç›®æ–‡æ¡£](./README.md)
            - [é—®é¢˜åé¦ˆ](https://github.com/${{ github.repository }}/issues)
          draft: false
          prerelease: false
          generate_release_notes: false

      - name: Trigger Docker build
        if: success()
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          event-type: release-published
          client-payload: '{"version": "${{ steps.get_version.outputs.version }}", "tag": "${{ steps.get_version.outputs.tag_name }}"}'
